<!DOCTYPE html>
<html>
<head>
    <title>Scafidi-Ziero-De Reggi: Survivor Blades</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css">

    <script src="libs/three.js"></script>
    <script src="libs/stats.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src='libs/dat.gui.min.js'></script>
    <script src='libs/LoaderSupport.js'></script>
    <script src='libs/OBJLoader2.js'></script>

    <script src='libs/BufferGeometryUtils.js'></script>

	<!--<script src="lib/GLTFLoader.js"></script>-->
	<!--<script src="lib/Detector.js"></script>-->
	<!--<script src="libs/ausiliarie.js"></script>-->
</head>



<body>
    <div id="container">
        
      <div>
                <div class="row">
                    <div class="col-1">
                        <img id="uniud" src="images/Uniud.png" width="100%" alt="Logo UNIUD">
                    </div>
                    <div class="col-10">
                        <p class="header">Survivor Blades</p>
                        <p class="title" align="center">ACQUISTA QUESTO DANNATO COLTELLO</p>
                    </div>
                    <div class="col-1">
                        <img id="uniud" src="images/acme_logo.png" width="100%" alt="Logo UNIUD">
                    </div>
                </div>
      </div>

        <div class="row justify-content-md-center">
            <div class="col-2">
                <p class="menuchoice">Modifica il MATERIALE</p>
                <table>
                    <tr> 
                        <td><a href="#" onClick="changeMaterial('gomma')"><img id="material" src="images/gomma.jpg" alt="gomma"></a></td>
                    </tr>
                </table>
            </div>


            <div class="col-8 h-100">
                <div style="height: 500px;" id="canvas"></div>
            </div>


            <div class="col-2">
                <p class="menuchoice">Modifica il BACKGROUND</p>
                    <table>
                        <tr> 
                            <td><a href="#" onClick="changeCubeMap('colosseo')"><img id="material" src="jungle.jpg" alt="jungle"></a></td>
                        </tr>
                        <tr> 
                            <td><a href="#" onClick="changeCubeMap('colosseo')"><img id="material" src="jungle.jpg" alt="jungle"></a></td>
                        </tr>
                        <tr> 
                            <td><a href="#" onClick="changeCubeMap('colosseo')"><img id="material" src="jungle.jpg" alt="jungle"></a></td>
                        </tr>
                        <tr> 
                            <td><a href="#" onClick="changeCubeMap('colosseo')"><img id="material" src="jungle.jpg" alt="jungle"></a></td>
                        </tr>
                    </table>
                    <h1>AA</h1>
            </div>
        </div>










        <script type="text/x-glsl" id="vertex">
        attribute vec4 tangent;
        varying vec3 vNormal;
        varying vec3 vPosition;
        varying vec2 vUv;
        varying vec3 vTangent;
        varying vec3 vBitangent;

        void main() {
            vec4 vPos = modelViewMatrix * vec4( position, 1.0 );
            vPosition = vPos.xyz;
            vNormal = normalize(normalMatrix * normal);
            vec3 objectTangent = vec3( tangent.xyz );
            vec3 transformedTangent = normalMatrix * objectTangent;
            vTangent = normalize( transformedTangent );
            vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
            vUv = uv;
            gl_Position = projectionMatrix * vPos;
        }
        </script>

        <script type="text/x-glsl" id="fragment">
            varying vec3 vNormal;
            varying vec3 vTangent;
            varying vec3 vBitangent;
            varying vec3 vPosition;
            varying vec2 vUv;
            uniform vec3 pointLightPosition; // in world space
            uniform vec3 clight;
            uniform vec3 cspec;
            uniform vec3 cdiff;
            uniform float roughness;
            uniform sampler2D normalMap;
            uniform vec2 normalScale;
            const float PI = 3.14159;

            vec3 FSchlick(float lDoth) {
                return (cspec + (vec3(1.0)-cspec)*pow(1.0 - lDoth,5.0));
            }

            float DGGX(float nDoth, float alpha) {
                float alpha2 = alpha*alpha;
                float d = nDoth*nDoth*(alpha2-1.0)+1.0;
                return (  alpha2 / (PI*d*d));
            }

            float G1(float dotProduct, float k) {
                return (dotProduct / (dotProduct*(1.0-k) + k) );
            }

            float GSmith(float nDotv, float nDotl) {
                    float k = roughness*roughness;
                    return G1(nDotl,k)*G1(nDotv,k);
            }


            void main() {
                vec4 lPosition = viewMatrix * vec4( pointLightPosition, 1.0 );
                vec3 l = normalize(lPosition.xyz - vPosition.xyz);
                vec3 normal = normalize( vNormal );
                vec3 tangent = normalize( vTangent );
                vec3 bitangent = normalize( vBitangent );
                mat3 vTBN = mat3( tangent, bitangent, normal );
                vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
                //mapN.xy = normalScale * mapN.xy;
                vec3 n = normalize( vTBN * mapN );
                vec3 v = normalize( -vPosition);
                vec3 h = normalize( v + l);
                // small quantity to prevent divisions by 0
                float nDotl = max(dot( n, l ),0.000001);
                float lDoth = max(dot( l, h ),0.000001);
                float nDoth = max(dot( n, h ),0.000001);
                float vDoth = max(dot( v, h ),0.000001);
                float nDotv = max(dot( n, v ),0.000001);
                vec3 fresnel = FSchlick(lDoth);
                vec3 BRDF = (vec3(1.0)-fresnel)*cdiff/PI + fresnel*GSmith(nDotv,nDotl)*DGGX(nDoth,roughness*roughness)/
                    (4.0*nDotl*nDotv);
                vec3 outRadiance = PI* clight * nDotl * BRDF;
                // gamma encode the final value
                gl_FragColor = vec4(pow( outRadiance, vec3(1.0/2.2)), 1.0);
            }
        </script>


        <script>
            container = document.getElementById('canvas');
            larghezza = document.getElementById('canvas').clientWidth -10;
            altezza = document.getElementById('canvas').clientHeight -10;
            console.log("altezza"+altezza);
            console.log("larghezza"+larghezza);
            var renderer = new THREE.WebGLRenderer( { antialias: true } );
            var camera = new THREE.PerspectiveCamera( 35, larghezza / altezza, 1, 1000 );
            var controls = new THREE.OrbitControls( camera, renderer.domElement );
            var scene = new THREE.Scene();

            // default: white, 1.0 intensity
            var lightParameters = {
                red: 1.0,
                green: 1.0,
                blue: 1.0,
                intensity: 1.0,
            }

            var textureParameters = {
                normalScale: 0.0,
            }

            var normalMap = loadTexture( "modello/source/Normal.jpg" );

            var uniforms = {
                    cspec:  { type: "v3", value: new THREE.Vector3(0.04,0.04,0.04) },
                    cdiff:  { type: "v3", value: new THREE.Vector3(0.8,0.8,0.8) },
                    roughness: {type: "f", value: 0.2},
                    normalMap:  { type: "t", value: normalMap},
                    normalScale: {type: "v2", value: new THREE.Vector2(1,1)},
                    pointLightPosition: { type: "v3", value: new THREE.Vector3() },
                    clight: { type: "v3", value: new THREE.Vector3() },
                    };

            vs = document.getElementById("vertex").textContent;
            fs = document.getElementById("fragment").textContent;

            var ourMaterial = new THREE.ShaderMaterial({ uniforms: uniforms, vertexShader: vs, fragmentShader: fs });
            ourMaterial.vertexTangents = true;
            ourMaterial.needsUpdate = true;
            console.log(ourMaterial);

            var loader = new THREE.OBJLoader2();
            loader.useIndices = true;
                loader.load( "modello/source/BGKnife.obj", function ( obj ) {
                    console.log(obj);
                    //geometry = gltf.scene.children[ 0 ].children[0].geometry;
                    geometry = obj.detail.loaderRootNode.children[0].geometry;
                    geometry.center();
                    mesh = new THREE.Mesh( geometry, ourMaterial );
                    mesh.scale.multiplyScalar( 0.1 );
                    THREE.BufferGeometryUtils.computeTangents(geometry);
                    scene.add( mesh );
                } );

            var lightMesh = new THREE.Mesh( new THREE.SphereGeometry( 1, 16, 16),
            new THREE.MeshBasicMaterial ({color: 0xffff00, wireframe:true}));
            lightMesh.position.set( 7.0, 7.0, 7.0 );
            uniforms.pointLightPosition.value = new THREE.Vector3(lightMesh.position.x, lightMesh.position.y, lightMesh.position.z);

            var gui;
            var stats = new Stats();

            function loadTexture(file) {
                    var texture = new THREE.TextureLoader().load( file , function ( texture ) {

                        texture.minFilter = THREE.LinearMipMapLinearFilter;
                        texture.anisotropy = renderer.getMaxAnisotropy();
                        texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                        texture.offset.set( 0, 0 );
                        texture.needsUpdate = true;
                        render();
                    } )
                    return texture;
            }

            function init() {
                renderer.setClearColor( 0x454545 );

                camera.position.set( 0, 0, 5 );
                scene.add( camera );
                scene.add(lightMesh);

                container.appendChild( renderer.domElement );
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( larghezza, altezza );

                //controls.addEventListener( 'change', render );
                controls.minDistance = 1;
                controls.maxDistance = 100;
                controls.enablePan = false;
                controls.update();

                window.addEventListener( 'resize', onResize, false );

                stats.domElement.style.position = 'absolute';
                stats.domElement.style.top = '0px';
                document.body.appendChild( stats.domElement );

                }

            function onResize() {
                renderer.setSize( larghezza, altezza );
                camera.aspect = ( larghezza / altezza );
                camera.updateProjectionMatrix();
            }

            function update() {
                requestAnimationFrame( update );
                stats.update();
                render();
            }

            function render() {
                updateUniforms();
                renderer.render( scene, camera );
            }

            function clearGui() {
                if ( gui ) gui.destroy();
                gui = new dat.GUI();
                gui.open();
            }

            function buildGui() {

                clearGui();
                lightSettings = gui.addFolder('Light Parameters');
                lightSettings.add(lightParameters,'red').min(0).max(1).onChange( function(newVal) { render() });
                lightSettings.add(lightParameters,'green').min(0).max(1).onChange( function(newVal) { render() });
                lightSettings.add(lightParameters,'blue').min(0).max(1).onChange( function(newVal) { render() });
                lightSettings.add(lightParameters,'intensity').min(0).max(10000).onChange( function(newVal) { render() });

                textureSettings = gui.addFolder('Texture parameters');
                textureSettings.add(textureParameters,'normalScale').min(-3).max(3).onChange( function( newVal ) {render()});
                }

            function updateUniforms() {

                            uniforms.clight.value = new THREE.Vector3(
                            lightParameters.red * lightParameters.intensity,
                        lightParameters.green * lightParameters.intensity,
                            lightParameters.blue * lightParameters.intensity);
                            uniforms.normalScale.value = new THREE.Vector2( textureParameters.normalScale, textureParameters.normalScale );

            }

            init();
            //buildGui();
            update();
            render();

        </script>





    <div>
        <div class="footer">
            <h1>&nbsp;</h1>
            <p>Loaded with innovations and backed by Bear,
        	this knife has everything. The knife features a half serrated,
        	drop point blade, a textured rubber grip, a steel pommel,
        	and an emergency whistle.
        	The durable sheath has a sharpener and a firestarter.</p>
        	<p align="center"><img src="images/coltello.png" width="75%"></p>
        </div>
        <div class="buy-section">
            <p>JUST $62</p>
            <a href="#"><img src="images/buyNow.png" alt="Compra adesso" width="300"></a>
        </div>
        <div>
            <p class="fondo">ACME Industries SDZ, Via delle Scienze 206, Udine. tel +39 0432 555555 fax +39 0432 5550123 mail: acmeind@uniud.it</p>
            <p>&nbsp;</p>
        </div>
    </div>


</div>
</body>

</html> 